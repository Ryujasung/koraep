var __storageselect=function(a){var u=function(f){function t(b){if(!b)return alert("UI load error."),!1;if("CERT_STORAGE"===f.type)a.ESVS.TargetObj.innerHTML=b;else{var d=document.createElement("div");document.body.insertBefore(d,document.body.firstChild);d.innerHTML=b}return!0}function m(b,d,k){var e=a.loadUI("driveselect")({type:"DEVICE_REMOVABLE_DISK",args:d,onConfirm:function(a){g=b;n=a;e.dispose();k.focus()},onCancel:function(){e.dispose();k.focus()}});e.show()}function h(b,d,k){var e=a.loadUI("sectokenselect")({type:b,args:d,onConfirm:function(a){g=b;n=a;e.dispose();k.focus()},onCancel:function(){e.dispose();k.focus()}});e.show()}function q(b,d,k){var e=a.loadUI("driveselect")({type:"DEVICE_SAVE_TOKEN",args:d,onConfirm:function(a){g=b;n=a;e.dispose();k.focus()},onCancel:function(){e.dispose();k.focus()}});e.show()}function w(b,d){var k=null;n=g=0;if(1===a.ESVS.Mode)if(a.plugin().valid){var e=a.plugin().GetDiskListNum();if(0<e){for(var c=[],f=0;f<e;f++){var h=f+1,p={};p.index=h;p.name=a.plugin().GetDiskDriveName(h);c[f]=p}k={list:c}}else a.plugin().GetLastErrorCode()}else return a.uiUtil().msgBox(d.IDS_MSGBOX_PLUGIN_ERROR_UNLOAD),!1;else if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNum(a.CONST.__USFB_M_DISK.device,function(c){if(0<c){for(var d=[],e=0;e<c;e++){var f=e+1,g={};g.index=f;g.name=a.nimservice().GetDiskDriveName(f);d[e]=g}k={list:d}}else a.nimservice().GetLastErrorCode();m(a.CONST.__USFB_M_DISK.device,k,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;4&a.ESVS.Mode||m(a.CONST.__USFB_M_DISK.device,k,b);return!0}function x(b,d){var k=null;n=g=0;if(1&a.ESVS.Mode)if(a.plugin().valid){var e=[],c=a.plugin().GetHSMInstallListNum();if(0<c)for(var f=0;f<c;f++){var m=f+1,p={},l=a.plugin().GetHSMInstallDriverName(m).split("|");p.index=m;p.name=l[0];p.driver=l[1];p.passage=l[2];p.validity=l[3];e[f]=p}k={list:e}}else return a.uiUtil().msgBox(d.IDS_MSGBOX_PLUGIN_ERROR_UNLOAD),!1;else if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNum(a.CONST.__USFB_M_HSMKEY.device,function(c){if(0<c){for(var d=[],e=0;e<c;e++){var f=e+1,g={},l=a.nimservice().GetSecureTokenName(f).split("|");g.index=f;g.name=l[0];g.driver=l[1];g.passage=l[2];d[e]=g}k={list:d}}else a.nimservice().GetLastErrorCode();h(a.CONST.__USFB_M_HSMKEY.device,k,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;4&a.ESVS.Mode||h(a.CONST.__USFB_M_HSMKEY.device,k,b);return!0}function u(b,d){n=g=0;if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNum(a.CONST.__USFB_M_SMARTCARD.device,function(d){if(0<d){for(var e=[],c=0;c<d;c++){var f=c+1,g={};g.index=f;g.name=a.nimservice().GetSmartCardName(f);e[c]=g}driveList={list:e}}else return-1===d&&(d=a.nimservice().GetLastErrorCode(),e=a.nimservice().GetLastErrorMessage(),console.log("***** GetCertsFromRemovable *****"),console.log("Err Code : ",d,"\nErr Msg : ",e)),a.certsList=null,!1;q(a.CONST.__USFB_M_SMARTCARD.device,driveList,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1}function s(b,d){if(!b||!d)return!1;a.uiUtil().MsgBox(d.IDS_MSGBOX_NOT_SUPPORTED_MEDIA);return!0}function y(b){if(a.CONST.__USFB_M_DISK.device>g||(a.CONST.__USFB_M_DISK.device===g||a.CONST.__USFB_M_HSMKEY.device===g)&&1>n)return a.uiUtil().msgBox(b.IDS_MSGBOX_ERROR_PLEASE_SELECT_STORAGE),!1;if("CERT_COPY"==f.type&&f.args.sourceDevice===g&&f.args.sourceDrive===n)return a.uiUtil().msgBox(b.IDS_MSGBOX_ERROR_WARNING_SAME_STORAGE),!1;if(("CERT_COPY"===f.type||"CERT_IMPORT"===f.type||"CERT_STORAGE"===f.type)&&a.CONST.__USFB_M_SMARTCARD.device===g&&0===n&&!confirm(b.IDS_CONFIRMBOX_WARNING_CHANGE_CERT))return!1;f.onConfirm(g,n);return!0}function l(b){if(!b)return!1;for(var d=a.ESVS.Media.list.split("|"),f=0;f<d.length;f++){var e=a.CONST.medias[d[f]];void 0!=e&&null!=e&&(e=document.getElementById("us-btn-storage-"+e.name),void 0!=e&&null!=e&&"us-layout-storage-btn-none"!=e.className&&(b===e?(e.className="us-layout-storage-btn-on",e.focus()):e.className="us-layout-storage-btn-off"))}return!0}function z(b){if(null==b||void 0==b)return!1;var d=!a.uiUtil().isItSupportingThisStorage(b);!1==d&&null!=a.ESVS.Media&&null!=a.ESVS.Media.list&&0>a.ESVS.Media.list.indexOf(b.name)&&(d=!0);if(d)return!1;var d=document.getElementById("us-btn-storage-btn-list"),f=document.createElement("li");f.setAttribute("id","us-storage-btn-li-"+b.name,0);f.setAttribute("mediaIndex",b.mediaIndex,0);7==b.mediaIndex&&(f.className="line-first");"hidden"===b.visibility?(f.style.display="none",f.style.visibility="hidden"):(f.style.display="block",f.style.visibility="visible");var e=document.createElement("button");e.setAttribute("type","button",0);e.setAttribute("id","us-btn-storage-"+b.name,0);e.setAttribute("title",b.label,0);e.setAttribute("tabindex",b.tabIndex,0);b.disabled?(e.onclick=function(){a.uiUtil().msgBox(A.IDS_MSGBOX_NOT_SUPPORTED_MEDIA)},e.className="us-layout-storage-btn-none"):(e.onclick=b.onclick,b.device===g?(e.className="us-layout-storage-btn-on",e.focus()):e.className="us-layout-storage-btn-off");f.appendChild(e);if("harddisk"!==b.name&&"webstorage"!==b.name){var c=document.createElement("span");c.className="us-drive-select";e.appendChild(c)}c=document.createElement("span");c.className="us-img-storage";var h=document.createElement("img");h.setAttribute("id","us-img-storage-"+b.name,0);h.setAttribute("alt",b.label,0);b.disabled?h.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+"_d.png",0):h.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+".png",0);c.appendChild(h);e.appendChild(c);c=document.createElement("span");c.setAttribute("id","us-lbl-storage-"+b.name,0);c.className="us-layout-lbl-storage";c.appendChild(document.createTextNode(b.label));e.appendChild(c);f.appendChild(e);d.appendChild(f);return!0}var B=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/layout/storageselect.html?version="+a.ver,!1);b.send(null);return b.responseText},v=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/storageselect_"+a.ESVS.Language+".js?version="+a.ver,!1);b.send(null);return b.responseText},A=eval(eval(v)()),r=a.ESVS.TabIndex,g=a.CONST.__USFB_M_DISK.device,n=0;null!=a.ESVS.Media&&null!=a.ESVS.Media.defaultdevice?g=a.uiUtil().getMediaDevice(a.ESVS.Media.defaultdevice):2==a.ESVS.Mode&&(g=a.CONST.__PF_M_LS.device);return function(){var b=eval(B),d=eval(eval(v)());t(b());b=document.getElementById("us-storage-select-lbl-title");b.appendChild(document.createTextNode(d.IDS_STORAGE_SELECTION));b.setAttribute("tabindex",r++,0);document.getElementById("us-storage-select-cls-btn-img").setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/x-btn.png",0);b=document.getElementById("us-storage-select-notice-lbl");"CERT_STORAGE"===f.type?b.appendChild(document.createTextNode(d.IDS_SAVE_NOTICE)):b.appendChild(document.createTextNode(d.IDS_COPY_NOTICE));4&a.ESVS.Mode&&a.nimservice()&&a.nimservice().GetAllMediaList(1,function(a,b){});for(var b=0,h=a.ESVS.Media.list.split("|"),e=0;e<h.length;e++){var c=a.CONST.medias[h[e]];if(void 0!=c&&null!=c){switch(c.device){case a.CONST.__USFB_M_DISK.device:c.label=d.IDS_STORAGE_REMOVABLE;c.disabled=2==a.ESVS.Mode;c.onclick=function(){w(this,d);l(this)};break;case a.CONST.__USFB_M_HSMKEY.device:c.label=d.IDS_STORAGE_SECTOKEN;c.disabled=!("win"==a.osName&&2!=a.ESVS.Mode);c.onclick=function(){x(this,d);l(this)};break;case a.CONST.__USFB_M_SMARTCARD.device:c.label=d.IDS_STORAGE_SAVETOKEN;c.disabled=!("win"==a.osName&&2!=a.ESVS.Mode);c.onclick=function(){u(this,d);l(this)};break;case a.CONST.__USFB_M_MOBILE.device:c.label=d.IDS_STORAGE_MOBILEPHONE;c.disabled="CERT_STORAGE"==f.type?!0:2==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__USFB_M_MOBILE.device;this.focus();l(this)};break;case a.CONST.__USFB_M_HDD.device:c.label=d.IDS_STORAGE_HARDDISK;c.disabled=2==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__USFB_M_HDD.device;this.focus();l(this)};break;case a.CONST.__USFB_M_MOBILETOKEN.device:c.label=d.IDS_STORAGE_MOBILETOKEN;c.disabled=2==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__USFB_M_MOBILETOKEN.device;this.focus();l(this)};break;case a.CONST.__PF_M_LS.device:c.label=d.IDS_STORAGE_LS;c.disabled=1==a.ESVS.Mode||"CERT_COPY"==f.type;c.onclick=function(){g=a.CONST.__PF_M_LS.device;this.focus();l(this)};break;case a.CONST.__PF_M_TOUCHSIGN.device:c.label=d.IDS_STORAGE_TOUCHSIGN;c.disabled=!0;c.onclick=function(){s(this,d)};break;case a.CONST.__PF_M_SMARTSIGN.device:c.label=d.IDS_STORAGE_SMARTSIGN;c.disabled=!0;c.onclick=function(){s(this,d)};break;case a.CONST.__PF_M_WEBSECTOKEN.device:c.label=d.IDS_STORAGE_WEBSECTOKEN;c.disabled=!0;c.onclick=function(){s(this,d)};break;case a.CONST.__PF_M_WEBSOFTTOKEN.device:c.label=d.IDS_STORAGE_WEBSOFTTOKEN;c.disabled=!0;c.onclick=function(){s(this,d)};break;default:c.label=d.IDS_STORAGE_ETC,c.disabled=!0,c.onclick=function(){s(this,d)}}c.tabIndex=r;c.mediaIndex=b+1;c.visibility="visible";z(c)&&(r++,b++,1==b&&document.getElementById("us-btn-storage-"+c.name).focus())}}document.getElementById("us-storage-select-warning-lbl").appendChild(document.createTextNode(d.IDS_WARNING));b=document.getElementById("us-storage-select-confirm-btn");b.setAttribute("value",d.IDS_CONFIRM,0);b.setAttribute("title",d.IDS_CONFIRM+d.IDS_BUTTON,0);b.setAttribute("tabindex",r++,0);b.onclick=function(){y(d)};b=document.getElementById("us-storage-select-cancel-btn");b.setAttribute("value",d.IDS_CANCEL,0);b.setAttribute("title",d.IDS_CANCEL+d.IDS_BUTTON,0);b.setAttribute("tabindex",r++,0);b.onclick=function(){f.onCancel()};b=document.getElementById("us-storage-select-cls-img-btn");b.setAttribute("title",d.IDS_STORAGE_SELECTION_CLOSE,0);b.setAttribute("tabindex",r++,0);b.onclick=function(){f.onCancel()};return document.getElementById("us-div-storage-select")}()};return function(f){var t=a.uiLayerLevel,m=a.uiUtil().getOverlay(t),h=u({type:f.type,args:f.args,onConfirm:f.onConfirm,onCancel:f.onCancel});h.style.zIndex=t+1;a.ESVS.TargetObj.insertBefore(m,a.ESVS.TargetObj.firstChild);var q=window.onresize;return{show:function(){draggable(h,document.getElementById("us-div-storage-select-title"));m.style.display="block";a.uiUtil().offsetResize(h);window.onresize=function(){a.uiUtil().offsetResize(h);q&&q()};a.uiLayerLevel+=10;a.ESVS.TabIndex+=30;setTimeout(function(){var a=h.getElementsByTagName("p");if(0<a.length)for(var f=0;f<a.length;f++)"us-storage-select-lbl-title"==a[f].id&&a[f].focus()},10)},hide:function(){m.style.display="none";h.style.display="none"},dispose:function(){window.onresize=function(){q&&q()};"CERT_STORAGE"===f.type?h.parentNode.removeChild(h):h.parentNode.parentNode.removeChild(h.parentNode);m.parentNode.removeChild(m);a.uiLayerLevel-=10;a.ESVS.TabIndex-=30}}}};